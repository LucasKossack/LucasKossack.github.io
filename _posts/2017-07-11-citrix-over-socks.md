---
layout: post
title: Proxying Citrix Receiver over SOCKS
---

A while back, I found myself in an interesting situation.  I had credentials to access Citrix inside a local network but my only way of accessing the network itself was over a SOCK4 proxy.  Using Firefox and [FoxyProxy](https://addons.mozilla.org/en-US/firefox/addon/foxyproxy-standard/) it was possible to view the Citrix web and download the receiver initialization .ica files.  I grabbed a few and then started looking at how to send receiver traffic through a SOCKS proxy.

While the Receiver can be configured to go through a SOCKS proxy it is not part of the client configuration.  Instead, the client queries the web portal for the SOCKS details.  Though it might be possible to fake a response to this request, it certainly isn't practical.  The solution?  Ignore receiver's proxy settings entirely and proxy the traffic at the firewall level using RedSocks!  Here's how:

Starting with a clean Ubuntu virtual machine, grab RedSocks from the official repositories.

{% highlight shell %}
apt-get update
apt-get install redsocks
{% endhighlight %}

Citrix Receiver isn't available in the repositories, so we'll have to install it manually.  Just grab the installer from (https://www.citrix.com/downloads/citrix-receiver/linux/receiver-for-linux-latest.html)

and install using dpkg:

{% highlight shell %}
dpkg -i /path/to/icaclient_*.deb
{% endhighlight %}

With everything installed, we can move on to configuration.  First off we'll modify the RedSocks config at `/etc/redsocks.conf`.  There are a few important things we need to set in this file, including the proxy ip, port, type, and setting redsocks to run as a daemon.  Here's an example configuration:

{% highlight shell %}
base {
	// debug: connection progress & client list on SIGUSR1
	log_debug = off;

	// info: start and end of client session
	log_info = on;

    // log file location
	log = "file:/tmp/redsocks.log";

	// detach from console
	daemon = on;

    //user and group redsock will run as
	user = redsocks;
	group = redsocks;

	redirector = iptables;
}

redsocks {
    //the ip and port we will send traffic to later
	local_ip = 127.0.0.1;
	local_port = 12345;

    //proxy ip and port
	ip = example.com;
	port = 43097;

	// known types: socks4, socks5, http-connect, http-relay
	type = socks4;

	// login = "foobar";
	// password = "baz";
}
{% endhighlight %}

With RedSocks configured, now all we need to do is start it and tell IPTables what traffic to send through the proxy.  Here are the scripts I use:

**start_redsocks.sh**
{% highlight shell %}
redsocks -c /etc/redsocks.conf
iptables -t nat -N REDSOCKS

iptables -t nat -A REDSOCKS -d 127.0.0.0/8 -j RETURN
iptables -t nat -A REDSOCKS -p tcp -j REDIRECT --to-ports 12345

iptables -t nat -A OUTPUT -p tcp -m owner --uid-owner user -j REDSOCKS
{% endhighlight %}

**stop_redsocks.sh**
{% highlight shell %}
sudo iptables -F
sudo iptables -X
sudo iptables -Z
sudo iptables -t nat -F
sudo iptables -t nat -X
sudo iptables -t nat -Z
killall redsocks
{% endhighlight %}

For the startup we're starting the RedSocks daemon using the configuration we modified earlier.  Then we're telling IPTables to send (almost) all traffic generated by the user `user` to RedSocks running on local port 12345.  Traffic from the 127.0.0.0/8 is excluded to prevent problems with access services on the local machine.

In the stop script we're cleaning out the firewall completely and then killing all RedSocks processes.  Because this is a clean VM there should be no issue with wiping the firewall.  For a machine with IPTables in use you should backup the configuration and and restore it after using RedSocks.

Now that our setup is complete, grab a few receiver application files from the Citrix server using Firefox, fire up RedSocks using start_redsocks.sh, and open one of the .ica files.  If everything was successful you should have a Citrix application load over a SOCKS proxy.

From here you can try to [break out](https://www.pentestpartners.com/security-blog/breaking-out-of-citrix-and-other-restricted-desktop-environments/) of the Citrix application and establish a shell on the system or just use the application to access other parts of the environment.  With all the traffic surrounding Citrix servers on a network it's easy to hide nefarious activities in plain sight.
